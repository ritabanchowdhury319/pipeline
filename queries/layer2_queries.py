SQL_abo_dna_for_pyspark_v6 = """
SELECT
    b.imc_key_no,
    b.imc_no,
    b.mo_yr_key_no,
    b.spon_imc_key_no as spon_imc_key_no,
    b.imc_months_after_signup as n_imc_months_after_signup,
    year(add_months(b.mo_yr_key_no,-b.imc_months_after_signup)) as dt_signup_year,
    CASE WHEN year(add_months(b.mo_yr_key_no,-b.imc_months_after_signup)) > 2015 THEN 1 ELSE 0 END as n_signup_year_after_2015,
    b.globl_imc_type_cd as i_globl_imc_type_cd,
    b.globl_bus_stat_cd as i_globl_bus_stat_cd,
    b.local_imc_type_desc as i_local_imc_type_desc,
    b.APP_1_AGE as n_app_1_age,
    CASE WHEN b.APP_1_AGE <= 34 THEN 1 ELSE 0 END as n_app_1_age_under_35,
    b.APP_1_GNDR_CD as i_app_1_gender,
    b.seg_alt_desc as i_seg_alt_desc,
    CASE WHEN b.IMC_RENEW_FLG = 'Y' THEN 1 ELSE 0 END as n_imc_renew_flg,
    b.imc_prsnl_pv as n_imc_prsnl_pv,
    LAG(b.imc_prsnl_pv, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_imc_prsnl_pv_previous,
    SUM(b.imc_prsnl_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_imc_prsnl_pv_sum_3m,
    SUM(b.imc_prsnl_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_imc_prsnl_pv_sum_6m,
    SUM(b.imc_prsnl_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_imc_prsnl_pv_sum_9m,
    SUM(b.imc_prsnl_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_imc_prsnl_pv_sum_12m,
    nvl(b.LAST_3DAY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0), 0) as n_pct_pv_last3_days,
    LAG(nvl(b.LAST_3DAY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_last3_days_previous,
    AVG(nvl(b.LAST_3DAY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_last3_days_avg_3m,
    AVG(nvl(b.LAST_3DAY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_last3_days_avg_6m,
    AVG(nvl(b.LAST_3DAY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_last3_days_avg_9m,
    AVG(nvl(b.LAST_3DAY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_last3_days_avg_12m,


    CASE WHEN b.GSC_RCUR_PV_FLG = 'Y' THEN 1 ELSE 0 END as n_recur_order_flg,
    b.GSC_RCUR_PV_LC_AMT as n_recur_order_pv,
    nvl(b.GSC_RCUR_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) as n_pct_pv_recur_order,


    (CASE WHEN b.imc_prsnl_pv > 0 THEN 1 ELSE 0 END) as n_prsnl_pv_nonzero,
    LAG((CASE WHEN b.imc_prsnl_pv > 0 THEN 1 ELSE 0 END), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_prsnl_pv_nonzero_previous,
    SUM((CASE WHEN b.imc_prsnl_pv > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_prsnl_pv_nonzero_mths_3m,
    SUM((CASE WHEN b.imc_prsnl_pv > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_prsnl_pv_nonzero_mths_6m,
    SUM((CASE WHEN b.imc_prsnl_pv > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_prsnl_pv_nonzero_mths_9m,
    SUM((CASE WHEN b.imc_prsnl_pv > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_prsnl_pv_nonzero_mths_12m,

    (b.imc_prsnl_pv - b.STLY_PV_LC_AMT) as n_improvement_stly_pv,

    nvl((b.imc_prsnl_pv - b.STLY_PV_LC_AMT) / NULLIF(b.STLY_PV_LC_AMT, 0), 0) as n_pct_improvement_stly_pv,
    LAG(nvl((b.imc_prsnl_pv - b.STLY_PV_LC_AMT) / NULLIF(b.STLY_PV_LC_AMT, 0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_improvement_stly_pv_previous,
    AVG(nvl((b.imc_prsnl_pv - b.STLY_PV_LC_AMT) / NULLIF(b.STLY_PV_LC_AMT, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_improvement_stly_pv_avg_3m,
    AVG(nvl((b.imc_prsnl_pv - b.STLY_PV_LC_AMT) / NULLIF(b.STLY_PV_LC_AMT, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_improvement_stly_pv_avg_6m,
    AVG(nvl((b.imc_prsnl_pv - b.STLY_PV_LC_AMT) / NULLIF(b.STLY_PV_LC_AMT, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_improvement_stly_pv_avg_9m,
    AVG(nvl((b.imc_prsnl_pv - b.STLY_PV_LC_AMT) / NULLIF(b.STLY_PV_LC_AMT, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_improvement_stly_pv_avg_12m,



    b.imc_prsnl_bv as n_imc_prsnl_bv,
    LAG(b.imc_prsnl_bv, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_imc_prsnl_bv_previous,
    SUM(b.imc_prsnl_bv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_imc_prsnl_bv_sum_3m,
    SUM(b.imc_prsnl_bv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_imc_prsnl_bv_sum_6m,
    SUM(b.imc_prsnl_bv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_imc_prsnl_bv_sum_9m,
    SUM(b.imc_prsnl_bv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_imc_prsnl_bv_sum_12m,




    nvl(pr.n_percentile_overall_grs_bns, 0) as n_percentile_overall_grs_bns,
    nvl(pr.n_percentile_overall_prsnl_pv, 0) as n_percentile_overall_prsnl_pv,
    nvl(pr.n_percentile_overall_group_pv, 0) as n_percentile_overall_group_pv,
    nvl(pr.n_percentile_overall_prsnl_bv, 0) as n_percentile_overall_prsnl_bv,
    nvl(pr.n_percentile_overall_group_bv, 0) as n_percentile_overall_group_bv,
    nvl(pr.n_percentile_region_grs_bns, 0) as n_percentile_region_grs_bns,
    nvl(pr.n_percentile_region_prsnl_pv, 0) as n_percentile_region_prsnl_pv,
    nvl(pr.n_percentile_region_group_pv, 0) as n_percentile_region_group_pv,
    nvl(pr.n_percentile_region_prsnl_bv, 0) as n_percentile_region_prsnl_bv,
    nvl(pr.n_percentile_region_group_bv, 0) as n_percentile_region_group_bv,
    nvl(pr.n_percentile_awd_rnk_grs_bns, 0) as n_percentile_awd_rnk_grs_bns,
    nvl(pr.n_percentile_awd_rnk_prsnl_pv, 0) as n_percentile_awd_rnk_prsnl_pv,
    nvl(pr.n_percentile_awd_rnk_group_pv, 0) as n_percentile_awd_rnk_group_pv,
    nvl(pr.n_percentile_awd_rnk_prsnl_bv, 0) as n_percentile_awd_rnk_prsnl_bv,
    nvl(pr.n_percentile_awd_rnk_group_bv, 0) as n_percentile_awd_rnk_group_bv,

    nvl(b.bns_grs_pln_comm_curr_amt / NULLIF(ar.overall_average_grs_bns,0),0) as n_index_overall_grs_bns,
    nvl(b.imc_prsnl_pv / NULLIF(ar.overall_average_prsnl_pv,0),0) as n_index_overall_prsnl_pv,
    nvl(b.imc_group_pv / NULLIF(ar.overall_average_group_pv,0),0) as n_index_overall_group_pv,
    nvl(b.imc_prsnl_bv / NULLIF(ar.overall_average_prsnl_bv,0),0) as n_index_overall_prsnl_bv,
    nvl(b.imc_group_bv / NULLIF(ar.overall_average_group_bv,0),0) as n_index_overall_group_bv,
    nvl(b.bns_grs_pln_comm_curr_amt / NULLIF(ar_region.region_average_grs_bns,0),0) as n_index_region_grs_bns,
    nvl(b.imc_prsnl_pv / NULLIF(ar_region.region_average_prsnl_pv,0),0) as n_index_region_prsnl_pv,
    nvl(b.imc_group_pv / NULLIF(ar_region.region_average_group_pv,0),0) as n_index_region_group_pv,
    nvl(b.imc_prsnl_bv / NULLIF(ar_region.region_average_prsnl_bv,0),0) as n_index_region_prsnl_bv,
    nvl(b.imc_group_bv / NULLIF(ar_region.region_average_group_bv,0),0) as n_index_region_group_bv,
    nvl(b.bns_grs_pln_comm_curr_amt / NULLIF(ar_awd.awd_rnk_average_grs_bns,0),0) as n_index_awd_rnk_grs_bns,
    nvl(b.imc_prsnl_pv / NULLIF(ar_awd.awd_rnk_average_prsnl_pv,0),0) as n_index_awd_rnk_prsnl_pv,
    nvl(b.imc_group_pv / NULLIF(ar_awd.awd_rnk_average_group_pv,0),0) as n_index_awd_rnk_group_pv,
    nvl(b.imc_prsnl_bv / NULLIF(ar_awd.awd_rnk_average_prsnl_bv,0),0) as n_index_awd_rnk_prsnl_bv,
    nvl(b.imc_group_bv / NULLIF(ar_awd.awd_rnk_average_group_bv,0),0) as n_index_awd_rnk_group_bv,




    b.REV_LC_AMT as n_rev_lc_amt,
    LAG(b.REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_rev_lc_amt_previous,
    SUM(b.REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_rev_lc_amt_sum_3m,
    SUM(b.REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_rev_lc_amt_sum_6m,
    SUM(b.REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_rev_lc_amt_sum_9m,
    SUM(b.REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_rev_lc_amt_sum_12m,
    nvl(b.LAST_3DAY_rev_lc_AMT / NULLIF(b.REV_LC_AMT,0), 0) as n_pct_rev_last3_days,
    LAG(nvl(b.LAST_3DAY_rev_lc_AMT / NULLIF(b.REV_LC_AMT,0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_rev_last3_days_previous,
    AVG(nvl(b.LAST_3DAY_rev_lc_AMT / NULLIF(b.REV_LC_AMT,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_rev_last3_days_avg_3m,
    AVG(nvl(b.LAST_3DAY_rev_lc_AMT / NULLIF(b.REV_LC_AMT,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_rev_last3_days_avg_6m,
    AVG(nvl(b.LAST_3DAY_rev_lc_AMT / NULLIF(b.REV_LC_AMT,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_rev_last3_days_avg_9m,
    AVG(nvl(b.LAST_3DAY_rev_lc_AMT / NULLIF(b.REV_LC_AMT,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_rev_last3_days_avg_12m,

    (b.rev_lc_amt - b.STLY_REV_LC_AMT) as n_improvement_stly_rev,

    nvl((b.rev_lc_amt - b.STLY_REV_LC_AMT) / NULLIF(b.rev_lc_amt, 0), 0) as n_pct_improvement_stly_rev,
    LAG(nvl((b.rev_lc_amt - b.STLY_REV_LC_AMT) / NULLIF(b.rev_lc_amt, 0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_improvement_stly_rev_previous,
    AVG(nvl((b.rev_lc_amt - b.STLY_REV_LC_AMT) / NULLIF(b.rev_lc_amt, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_improvement_stly_rev_avg_3m,
    AVG(nvl((b.rev_lc_amt - b.STLY_REV_LC_AMT) / NULLIF(b.rev_lc_amt, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_improvement_stly_rev_avg_6m,
    AVG(nvl((b.rev_lc_amt - b.STLY_REV_LC_AMT) / NULLIF(b.rev_lc_amt, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_improvement_stly_rev_avg_9m,
    AVG(nvl((b.rev_lc_amt - b.STLY_REV_LC_AMT) / NULLIF(b.rev_lc_amt, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_improvement_stly_rev_avg_12m,
    
    (CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END) as n_bns_pct,
    LAG((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bns_pct_previous,
    AVG((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_pct_avg_3m,
    AVG((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_pct_avg_6m,
    AVG((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_pct_avg_9m,
    AVG((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_pct_avg_12m,
    MAX((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_pct_MAX_3m,
    MAX((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_pct_MAX_6m,
    MAX((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_pct_MAX_9m,
    MAX((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN b.BNS_PCT ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_pct_MAX_12m,
    (CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' AND b.BNS_PCT >= 9 THEN 1 ELSE 0 END) as n_bns_9plus,
    LAG((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' AND b.BNS_PCT >= 9 THEN 1 ELSE 0 END), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bns_9plus_previous,
    SUM((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' AND b.BNS_PCT >= 9 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_9plus_sum_3m,
    SUM((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' AND b.BNS_PCT >= 9 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_9plus_sum_6m,
    SUM((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' AND b.BNS_PCT >= 9 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_9plus_sum_9m,
    SUM((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' AND b.BNS_PCT >= 9 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_9plus_sum_12m,
    (CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN 1 ELSE 0 END) as n_bns_flag,
    LAG((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN 1 ELSE 0 END) , 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bns_flag_previous,
    SUM((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN 1 ELSE 0 END) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_flg_count_3m,
    SUM((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN 1 ELSE 0 END) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_flg_count_6m,
    SUM((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN 1 ELSE 0 END) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_flg_count_9m,
    SUM((CASE WHEN b.I_IMC_EARN_BNS_FLG = 'Y' THEN 1 ELSE 0 END) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_flg_count_12m,
    
    
    b.bns_grs_pln_comm_curr_amt as n_bns_grs_pln_comm_curr_amt,
    LAG(b.bns_grs_pln_comm_curr_amt, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bns_grs_pln_comm_curr_amt_previous,
    SUM(b.bns_grs_pln_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_grs_pln_comm_curr_amt_sum_3m,
    SUM(b.bns_grs_pln_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_grs_pln_comm_curr_amt_sum_6m,
    SUM(b.bns_grs_pln_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_grs_pln_comm_curr_amt_sum_9m,
    SUM(b.bns_grs_pln_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_grs_pln_comm_curr_amt_sum_12m,


    nvl(b.bns_dif_comm_curr_amt / NULLIF(b.bns_grs_pln_comm_curr_amt,0), 0) as n_pct_grs_bns_from_diff,
    LAG(nvl(b.bns_dif_comm_curr_amt / NULLIF(b.bns_grs_pln_comm_curr_amt,0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_grs_bns_from_diff_previous,
    AVG(nvl(b.bns_dif_comm_curr_amt / NULLIF(b.bns_grs_pln_comm_curr_amt,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_grs_bns_from_diff_avg_3m,
    AVG(nvl(b.bns_dif_comm_curr_amt / NULLIF(b.bns_grs_pln_comm_curr_amt,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_grs_bns_from_diff_avg_6m,
    AVG(nvl(b.bns_dif_comm_curr_amt / NULLIF(b.bns_grs_pln_comm_curr_amt,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_grs_bns_from_diff_avg_9m,
    AVG(nvl(b.bns_dif_comm_curr_amt / NULLIF(b.bns_grs_pln_comm_curr_amt,0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_grs_bns_from_diff_avg_12m,

    b.bns_pers_comm_curr_amt as n_bns_pers_comm_curr_amt,
    LAG(b.bns_pers_comm_curr_amt, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bns_pers_comm_curr_amt_previous,
    SUM(b.bns_pers_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_pers_comm_curr_amt_sum_3m,
    SUM(b.bns_pers_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_pers_comm_curr_amt_sum_6m,
    SUM(b.bns_pers_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_pers_comm_curr_amt_sum_9m,
    SUM(b.bns_pers_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_pers_comm_curr_amt_sum_12m,


    b.bns_dif_comm_curr_amt as n_bns_dif_comm_curr_amt,
    LAG(b.bns_dif_comm_curr_amt, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bns_dif_comm_curr_amt_previous,
    SUM(b.bns_dif_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_dif_comm_curr_amt_sum_3m,
    SUM(b.bns_dif_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_dif_comm_curr_amt_sum_6m,
    SUM(b.bns_dif_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_dif_comm_curr_amt_sum_9m,
    SUM(b.bns_dif_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_dif_comm_curr_amt_sum_12m,

    SUM(CASE WHEN b.bns_grs_pln_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_grs_nonzero_mths_3m,
    SUM(CASE WHEN b.bns_grs_pln_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_grs_nonzero_mths_6m,
    SUM(CASE WHEN b.bns_grs_pln_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_grs_nonzero_mths_9m,
    SUM(CASE WHEN b.bns_grs_pln_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_grs_nonzero_mths_12m,
    SUM(CASE WHEN b.bns_pers_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_pers_nonzero_mths_3m,
    SUM(CASE WHEN b.bns_pers_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_pers_nonzero_mths_6m,
    SUM(CASE WHEN b.bns_pers_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_pers_nonzero_mths_9m,
    SUM(CASE WHEN b.bns_pers_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_pers_nonzero_mths_12m,
    SUM(CASE WHEN b.bns_dif_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bns_dif_nonzero_mths_3m,
    SUM(CASE WHEN b.bns_dif_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bns_dif_nonzero_mths_6m,
    SUM(CASE WHEN b.bns_dif_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bns_dif_nonzero_mths_9m,
    SUM(CASE WHEN b.bns_dif_comm_curr_amt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bns_dif_nonzero_mths_12m,



    b.dmd_ord_cnt as n_dmd_ord_cnt,
    LAG(b.dmd_ord_cnt, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_dmd_ord_cnt_previous,
    SUM(b.dmd_ord_cnt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_dmd_ord_cnt_sum_3m,
    SUM(b.dmd_ord_cnt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_dmd_ord_cnt_sum_6m,
    SUM(b.dmd_ord_cnt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_dmd_ord_cnt_sum_9m,
    SUM(b.dmd_ord_cnt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_dmd_ord_cnt_sum_12m,
    CASE WHEN b.dmd_ord_cnt > 0 THEN 1 ELSE 0 END as n_dmd_ord_cnt_nonzero,
    CASE WHEN LAG(b.dmd_ord_cnt, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) > 0 THEN 1 ELSE 0 END as n_dmd_ord_cnt_nonzero_previous,
    SUM(CASE WHEN b.dmd_ord_cnt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_dmd_ord_cnt_nonzero_mths_3m,
    SUM(CASE WHEN b.dmd_ord_cnt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_dmd_ord_cnt_nonzero_mths_6m,
    SUM(CASE WHEN b.dmd_ord_cnt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_dmd_ord_cnt_nonzero_mths_9m,
    SUM(CASE WHEN b.dmd_ord_cnt > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_dmd_ord_cnt_nonzero_mths_12m,

    nvl(b.LAST_3DAY_ORD_CNT / NULLIF(b.dmd_ord_cnt,0),0) as n_pct_dmd_ord_last3_days,
    LAG(nvl(b.LAST_3DAY_ORD_CNT / NULLIF(b.dmd_ord_cnt,0),0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_dmd_ord_last3_days_previous,
    AVG(nvl(b.LAST_3DAY_ORD_CNT / NULLIF(b.dmd_ord_cnt,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_dmd_ord_last3_days_avg_3m,
    AVG(nvl(b.LAST_3DAY_ORD_CNT / NULLIF(b.dmd_ord_cnt,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_dmd_ord_last3_days_avg_6m,
    AVG(nvl(b.LAST_3DAY_ORD_CNT / NULLIF(b.dmd_ord_cnt,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_dmd_ord_last3_days_avg_9m,
    AVG(nvl(b.LAST_3DAY_ORD_CNT / NULLIF(b.dmd_ord_cnt,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_dmd_ord_last3_days_avg_12m,




    ((CASE WHEN b.BL_NUTRITION_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_BEAUTY_PV_FLG  = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_DURABLES_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_HOMECARE_PV_FLG = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN  b.BL_PERSCARE_PV_FLG  = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN  b.BL_OTHER_PV_FLG  = 'Y' THEN 1 ELSE 0 END)) as n_business_lines,
    LAG(((CASE WHEN b.BL_NUTRITION_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_BEAUTY_PV_FLG  = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN b.BL_DURABLES_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_HOMECARE_PV_FLG = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN  b.BL_PERSCARE_PV_FLG  = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN  b.BL_OTHER_PV_FLG  = 'Y' THEN 1 ELSE 0 END)), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_business_lines_previous,
    AVG(((CASE WHEN b.BL_NUTRITION_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_BEAUTY_PV_FLG  = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN b.BL_DURABLES_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_HOMECARE_PV_FLG = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN  b.BL_PERSCARE_PV_FLG  = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN  b.BL_OTHER_PV_FLG  = 'Y' THEN 1 ELSE 0 END))) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_business_lines_avg_3m,
    AVG(((CASE WHEN b.BL_NUTRITION_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_BEAUTY_PV_FLG  = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN b.BL_DURABLES_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_HOMECARE_PV_FLG = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN  b.BL_PERSCARE_PV_FLG  = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN  b.BL_OTHER_PV_FLG  = 'Y' THEN 1 ELSE 0 END))) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_business_lines_avg_6m,
    AVG(((CASE WHEN b.BL_NUTRITION_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_BEAUTY_PV_FLG  = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN b.BL_DURABLES_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_HOMECARE_PV_FLG = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN  b.BL_PERSCARE_PV_FLG  = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN  b.BL_OTHER_PV_FLG  = 'Y' THEN 1 ELSE 0 END))) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_business_lines_avg_9m,
    AVG(((CASE WHEN b.BL_NUTRITION_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_BEAUTY_PV_FLG  = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN b.BL_DURABLES_PV_FLG = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN b.BL_HOMECARE_PV_FLG = 'Y' THEN 1 ELSE 0 END) +(CASE WHEN  b.BL_PERSCARE_PV_FLG  = 'Y' THEN 1 ELSE 0 END) + (CASE WHEN  b.BL_OTHER_PV_FLG  = 'Y' THEN 1 ELSE 0 END))) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_business_lines_avg_12m,

    nvl(b.BL_BEAUTY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) as n_pct_pv_bl_beauty,
    LAG(nvl(b.BL_BEAUTY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_bl_beauty_previous,
    AVG(nvl(b.BL_BEAUTY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_bl_beauty_AVG_3m,
    AVG(nvl(b.BL_BEAUTY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_bl_beauty_AVG_6m,
    AVG(nvl(b.BL_BEAUTY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_bl_beauty_AVG_9m,
    AVG(nvl(b.BL_BEAUTY_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_bl_beauty_AVG_12m,
    nvl(b.BL_DURABLES_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) as n_pct_pv_bl_DURABLES,
    LAG(nvl(b.BL_DURABLES_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_bl_DURABLES_previous,
    AVG(nvl(b.BL_DURABLES_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_bl_DURABLES_AVG_3m,
    AVG(nvl(b.BL_DURABLES_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_bl_DURABLES_AVG_6m,
    AVG(nvl(b.BL_DURABLES_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_bl_DURABLES_AVG_9m,
    AVG(nvl(b.BL_DURABLES_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_bl_DURABLES_AVG_12m,
    nvl(b.BL_homecare_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) as n_pct_pv_bl_homecare,
    LAG(nvl(b.BL_homecare_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) , 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_bl_homecare_previous,
    AVG(nvl(b.BL_homecare_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_bl_homecare_AVG_3m,
    AVG(nvl(b.BL_homecare_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_bl_homecare_AVG_6m,
    AVG(nvl(b.BL_homecare_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_bl_homecare_AVG_9m,
    AVG(nvl(b.BL_homecare_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_bl_homecare_AVG_12m,
    nvl(b.BL_NUTRITION_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) as n_pct_pv_bl_NUTRITION,
    LAG(nvl(b.BL_NUTRITION_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_bl_NUTRITION_previous,
    AVG(nvl(b.BL_NUTRITION_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_bl_NUTRITION_AVG_3m,
    AVG(nvl(b.BL_NUTRITION_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_bl_NUTRITION_AVG_6m,
    AVG(nvl(b.BL_NUTRITION_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_bl_NUTRITION_AVG_9m,
    AVG(nvl(b.BL_NUTRITION_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_bl_NUTRITION_AVG_12m,
    nvl(b.BL_PERSCARE_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) as n_pct_pv_bl_PERSCARE,
    LAG(nvl(b.BL_PERSCARE_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_bl_PERSCARE_previous,
    AVG(nvl(b.BL_PERSCARE_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_bl_PERSCARE_AVG_3m,
    AVG(nvl(b.BL_PERSCARE_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_bl_PERSCARE_AVG_6m,
    AVG(nvl(b.BL_PERSCARE_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_bl_PERSCARE_AVG_9m,
    AVG(nvl(b.BL_PERSCARE_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_bl_PERSCARE_AVG_12m,
    nvl(b.BL_OTHER_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0) as n_pct_pv_bl_OTHER,
    LAG(nvl(b.BL_OTHER_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_bl_OTHER_previous,
    AVG(nvl(b.BL_OTHER_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_bl_OTHER_AVG_3m,
    AVG(nvl(b.BL_OTHER_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_bl_OTHER_AVG_6m,
    AVG(nvl(b.BL_OTHER_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_bl_OTHER_AVG_9m,
    AVG(nvl(b.BL_OTHER_PV_LC_AMT / NULLIF(b.imc_prsnl_pv, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_bl_OTHER_AVG_12m,

    (CASE WHEN b.BL_BEAUTY_PV_LC_AMT > 0 THEN 1 ELSE 0 END) as n_bl_beauty_pv_nonzero,
    LAG((CASE WHEN b.BL_BEAUTY_PV_LC_AMT > 0 THEN 1 ELSE 0 END), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bl_beauty_pv_nonzero_previous,
    SUM((CASE WHEN b.BL_BEAUTY_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bl_beauty_pv_nonzero_mths_3m,
    SUM((CASE WHEN b.BL_BEAUTY_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bl_beauty_pv_nonzero_mths_6m,
    SUM((CASE WHEN b.BL_BEAUTY_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bl_beauty_pv_nonzero_mths_9m,
    SUM((CASE WHEN b.BL_BEAUTY_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bl_beauty_pv_nonzero_mths_12m,
    (CASE WHEN b.BL_DURABLES_PV_LC_AMT > 0 THEN 1 ELSE 0 END) as n_bl_DURABLES_pv_nonzero,
    LAG((CASE WHEN b.BL_DURABLES_PV_LC_AMT > 0 THEN 1 ELSE 0 END), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bl_DURABLES_pv_nonzero_previous,
    SUM((CASE WHEN b.BL_DURABLES_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bl_DURABLES_pv_nonzero_mths_3m,
    SUM((CASE WHEN b.BL_DURABLES_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bl_DURABLES_pv_nonzero_mths_6m,
    SUM((CASE WHEN b.BL_DURABLES_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bl_DURABLES_pv_nonzero_mths_9m,
    SUM((CASE WHEN b.BL_DURABLES_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bl_DURABLES_pv_nonzero_mths_12m,
    (CASE WHEN b.BL_HOMECARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END) as n_bl_HOMECARE_pv_nonzero,
    LAG((CASE WHEN b.BL_HOMECARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END) , 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bl_HOMECARE_pv_nonzero_previous,
    SUM((CASE WHEN b.BL_HOMECARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bl_HOMECARE_pv_nonzero_mths_3m,
    SUM((CASE WHEN b.BL_HOMECARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bl_HOMECARE_pv_nonzero_mths_6m,
    SUM((CASE WHEN b.BL_HOMECARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bl_HOMECARE_pv_nonzero_mths_9m,
    SUM((CASE WHEN b.BL_HOMECARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bl_HOMECARE_pv_nonzero_mths_12m,
    (CASE WHEN b.BL_NUTRITION_PV_LC_AMT > 0 THEN 1 ELSE 0 END) as n_bl_NUTRITION_pv_nonzero,
    LAG((CASE WHEN b.BL_NUTRITION_PV_LC_AMT > 0 THEN 1 ELSE 0 END), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bl_NUTRITION_pv_nonzero_previous,
    SUM((CASE WHEN b.BL_NUTRITION_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bl_NUTRITION_pv_nonzero_mths_3m,
    SUM((CASE WHEN b.BL_NUTRITION_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bl_NUTRITION_pv_nonzero_mths_6m,
    SUM((CASE WHEN b.BL_NUTRITION_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bl_NUTRITION_pv_nonzero_mths_9m,
    SUM((CASE WHEN b.BL_NUTRITION_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bl_NUTRITION_pv_nonzero_mths_12m,
    (CASE WHEN b.BL_PERSCARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END) as n_bl_PERSCARE_pv_nonzero,
    LAG((CASE WHEN b.BL_PERSCARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bl_PERSCARE_pv_nonzero_previous,
    SUM((CASE WHEN b.BL_PERSCARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bl_PERSCARE_pv_nonzero_mths_3m,
    SUM((CASE WHEN b.BL_PERSCARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bl_PERSCARE_pv_nonzero_mths_6m,
    SUM((CASE WHEN b.BL_PERSCARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bl_PERSCARE_pv_nonzero_mths_9m,
    SUM((CASE WHEN b.BL_PERSCARE_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bl_PERSCARE_pv_nonzero_mths_12m,
    (CASE WHEN b.BL_OTHER_PV_LC_AMT > 0 THEN 1 ELSE 0 END) as n_bl_OTHER_pv_nonzero,
    LAG((CASE WHEN b.BL_OTHER_PV_LC_AMT > 0 THEN 1 ELSE 0 END), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_bl_OTHER_pv_nonzero_previous,
    SUM((CASE WHEN b.BL_OTHER_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_bl_OTHER_pv_nonzero_mths_3m,
    SUM((CASE WHEN b.BL_OTHER_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_bl_OTHER_pv_nonzero_mths_6m,
    SUM((CASE WHEN b.BL_OTHER_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_bl_OTHER_pv_nonzero_mths_9m,
    SUM((CASE WHEN b.BL_OTHER_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_bl_OTHER_pv_nonzero_mths_12m,

    b.BL_BEAUTY_PV_LC_AMT as n_BL_BEAUTY_pv_lc_amt,
    LAG(b.BL_BEAUTY_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_BEAUTY_pv_lc_amt_previous,
    SUM(b.BL_BEAUTY_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_BEAUTY_pv_lc_amt_sum_3m,
    SUM(b.BL_BEAUTY_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_BEAUTY_pv_lc_amt_sum_6m,
    SUM(b.BL_BEAUTY_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_BEAUTY_pv_lc_amt_sum_9m,
    SUM(b.BL_BEAUTY_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_BEAUTY_pv_lc_amt_sum_12m,
    b.BL_DURABLES_PV_LC_AMT as n_BL_DURABLES_pv_lc_amt,
    LAG(b.BL_DURABLES_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_DURABLES_pv_lc_amt_previous,
    SUM(b.BL_DURABLES_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_DURABLES_pv_lc_amt_sum_3m,
    SUM(b.BL_DURABLES_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_DURABLES_pv_lc_amt_sum_6m,
    SUM(b.BL_DURABLES_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_DURABLES_pv_lc_amt_sum_9m,
    SUM(b.BL_DURABLES_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_DURABLES_pv_lc_amt_sum_12m,
    b.BL_HOMECARE_PV_LC_AMT as n_BL_HOMECARE_pv_lc_amt,
    LAG(b.BL_HOMECARE_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_HOMECARE_pv_lc_amt_previous,
    SUM(b.BL_HOMECARE_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_HOMECARE_pv_lc_amt_sum_3m,
    SUM(b.BL_HOMECARE_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_HOMECARE_pv_lc_amt_sum_6m,
    SUM(b.BL_HOMECARE_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_HOMECARE_pv_lc_amt_sum_9m,
    SUM(b.BL_HOMECARE_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_HOMECARE_pv_lc_amt_sum_12m,
    b.BL_NUTRITION_PV_LC_AMT as n_BL_NUTRITION_pv_lc_amt,
    LAG(b.BL_NUTRITION_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_NUTRITION_pv_lc_amt_previous,
    SUM(b.BL_NUTRITION_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_NUTRITION_pv_lc_amt_sum_3m,
    SUM(b.BL_NUTRITION_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_NUTRITION_pv_lc_amt_sum_6m,
    SUM(b.BL_NUTRITION_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_NUTRITION_pv_lc_amt_sum_9m,
    SUM(b.BL_NUTRITION_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_NUTRITION_pv_lc_amt_sum_12m,
    b.BL_PERSCARE_PV_LC_AMT as n_BL_PERSCARE_pv_lc_amt,
    LAG(b.BL_PERSCARE_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_PERSCARE_pv_lc_amt_previous,
    SUM(b.BL_PERSCARE_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_PERSCARE_pv_lc_amt_sum_3m,
    SUM(b.BL_PERSCARE_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_PERSCARE_pv_lc_amt_sum_6m,
    SUM(b.BL_PERSCARE_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_PERSCARE_pv_lc_amt_sum_9m,
    SUM(b.BL_PERSCARE_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_PERSCARE_pv_lc_amt_sum_12m,
    b.BL_OTHER_PV_LC_AMT as n_BL_OTHER_pv_lc_amt,
    LAG(b.BL_OTHER_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_OTHER_pv_lc_amt_previous,
    SUM(b.BL_OTHER_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_OTHER_pv_lc_amt_sum_3m,
    SUM(b.BL_OTHER_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_OTHER_pv_lc_amt_sum_6m,
    SUM(b.BL_OTHER_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_OTHER_pv_lc_amt_sum_9m,
    SUM(b.BL_OTHER_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_OTHER_pv_lc_amt_sum_12m,

    b.BL_BEAUTY_bv_LC_AMT as n_BL_BEAUTY_bv_lc_amt,
    LAG(b.BL_BEAUTY_bv_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_BEAUTY_bv_lc_amt_previous,
    SUM(b.BL_BEAUTY_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_BEAUTY_bv_lc_amt_sum_3m,
    SUM(b.BL_BEAUTY_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_BEAUTY_bv_lc_amt_sum_6m,
    SUM(b.BL_BEAUTY_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_BEAUTY_bv_lc_amt_sum_9m,
    SUM(b.BL_BEAUTY_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_BEAUTY_bv_lc_amt_sum_12m,
    b.BL_DURABLES_bv_LC_AMT as n_BL_DURABLES_bv_lc_amt,
    LAG(b.BL_DURABLES_bv_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_DURABLES_bv_lc_amt_previous,
    SUM(b.BL_DURABLES_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_DURABLES_bv_lc_amt_sum_3m,
    SUM(b.BL_DURABLES_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_DURABLES_bv_lc_amt_sum_6m,
    SUM(b.BL_DURABLES_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_DURABLES_bv_lc_amt_sum_9m,
    SUM(b.BL_DURABLES_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_DURABLES_bv_lc_amt_sum_12m,
    b.BL_HOMECARE_bv_LC_AMT as n_BL_HOMECARE_bv_lc_amt,
    LAG(b.BL_HOMECARE_bv_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_HOMECARE_bv_lc_amt_previous,
    SUM(b.BL_HOMECARE_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_HOMECARE_bv_lc_amt_sum_3m,
    SUM(b.BL_HOMECARE_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_HOMECARE_bv_lc_amt_sum_6m,
    SUM(b.BL_HOMECARE_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_HOMECARE_bv_lc_amt_sum_9m,
    SUM(b.BL_HOMECARE_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_HOMECARE_bv_lc_amt_sum_12m,
    b.BL_NUTRITION_bv_LC_AMT as n_BL_NUTRITION_bv_lc_amt,
    LAG(b.BL_NUTRITION_bv_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_NUTRITION_bv_lc_amt_previous,
    SUM(b.BL_NUTRITION_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_NUTRITION_bv_lc_amt_sum_3m,
    SUM(b.BL_NUTRITION_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_NUTRITION_bv_lc_amt_sum_6m,
    SUM(b.BL_NUTRITION_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_NUTRITION_bv_lc_amt_sum_9m,
    SUM(b.BL_NUTRITION_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_NUTRITION_bv_lc_amt_sum_12m,
    b.BL_PERSCARE_bv_LC_AMT as n_BL_PERSCARE_bv_lc_amt,
    LAG(b.BL_PERSCARE_bv_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_PERSCARE_bv_lc_amt_previous,
    SUM(b.BL_PERSCARE_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_PERSCARE_bv_lc_amt_sum_3m,
    SUM(b.BL_PERSCARE_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_PERSCARE_bv_lc_amt_sum_6m,
    SUM(b.BL_PERSCARE_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_PERSCARE_bv_lc_amt_sum_9m,
    SUM(b.BL_PERSCARE_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_PERSCARE_bv_lc_amt_sum_12m,
    b.BL_OTHER_bv_LC_AMT as n_BL_OTHER_bv_lc_amt,
    LAG(b.BL_OTHER_bv_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_OTHER_bv_lc_amt_previous,
    SUM(b.BL_OTHER_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_OTHER_bv_lc_amt_sum_3m,
    SUM(b.BL_OTHER_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_OTHER_bv_lc_amt_sum_6m,
    SUM(b.BL_OTHER_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_OTHER_bv_lc_amt_sum_9m,
    SUM(b.BL_OTHER_bv_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_OTHER_bv_lc_amt_sum_12m,

    b.BL_BEAUTY_REV_LC_AMT as n_BL_BEAUTY_REV_lc_amt,
    LAG(b.BL_BEAUTY_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_BEAUTY_REV_lc_amt_previous,
    SUM(b.BL_BEAUTY_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_BEAUTY_REV_lc_amt_sum_3m,
    SUM(b.BL_BEAUTY_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_BEAUTY_REV_lc_amt_sum_6m,
    SUM(b.BL_BEAUTY_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_BEAUTY_REV_lc_amt_sum_9m,
    SUM(b.BL_BEAUTY_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_BEAUTY_REV_lc_amt_sum_12m,
    b.BL_DURABLES_REV_LC_AMT as n_BL_DURABLES_REV_lc_amt,
    LAG(b.BL_DURABLES_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_DURABLES_REV_lc_amt_previous,
    SUM(b.BL_DURABLES_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_DURABLES_REV_lc_amt_sum_3m,
    SUM(b.BL_DURABLES_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_DURABLES_REV_lc_amt_sum_6m,
    SUM(b.BL_DURABLES_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_DURABLES_REV_lc_amt_sum_9m,
    SUM(b.BL_DURABLES_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_DURABLES_REV_lc_amt_sum_12m,
    b.BL_HOMECARE_REV_LC_AMT as n_BL_HOMECARE_REV_lc_amt,
    LAG(b.BL_HOMECARE_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_HOMECARE_REV_lc_amt_previous,
    SUM(b.BL_HOMECARE_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_HOMECARE_REV_lc_amt_sum_3m,
    SUM(b.BL_HOMECARE_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_HOMECARE_REV_lc_amt_sum_6m,
    SUM(b.BL_HOMECARE_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_HOMECARE_REV_lc_amt_sum_9m,
    SUM(b.BL_HOMECARE_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_HOMECARE_REV_lc_amt_sum_12m,
    b.BL_NUTRITION_REV_LC_AMT as n_BL_NUTRITION_REV_lc_amt,
    LAG(b.BL_NUTRITION_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_NUTRITION_REV_lc_amt_previous,
    SUM(b.BL_NUTRITION_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_NUTRITION_REV_lc_amt_sum_3m,
    SUM(b.BL_NUTRITION_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_NUTRITION_REV_lc_amt_sum_6m,
    SUM(b.BL_NUTRITION_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_NUTRITION_REV_lc_amt_sum_9m,
    SUM(b.BL_NUTRITION_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_NUTRITION_REV_lc_amt_sum_12m,
    b.BL_PERSCARE_REV_LC_AMT as n_BL_PERSCARE_REV_lc_amt,
    LAG(b.BL_PERSCARE_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_PERSCARE_REV_lc_amt_previous,
    SUM(b.BL_PERSCARE_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_PERSCARE_REV_lc_amt_sum_3m,
    SUM(b.BL_PERSCARE_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_PERSCARE_REV_lc_amt_sum_6m,
    SUM(b.BL_PERSCARE_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_PERSCARE_REV_lc_amt_sum_9m,
    SUM(b.BL_PERSCARE_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_PERSCARE_REV_lc_amt_sum_12m,
    b.BL_OTHER_REV_LC_AMT as n_BL_OTHER_REV_lc_amt,
    LAG(b.BL_OTHER_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_BL_OTHER_REV_lc_amt_previous,
    SUM(b.BL_OTHER_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_BL_OTHER_REV_lc_amt_sum_3m,
    SUM(b.BL_OTHER_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_BL_OTHER_REV_lc_amt_sum_6m,
    SUM(b.BL_OTHER_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_BL_OTHER_REV_lc_amt_sum_9m,
    SUM(b.BL_OTHER_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_BL_OTHER_REV_lc_amt_sum_12m,




    b.GSC_WEB_PV_LC_AMT as n_gsc_web_pv_lc_amt,
    LAG(b.GSC_WEB_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_web_pv_lc_amt_previous,
    SUM(b.GSC_WEB_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_web_pv_lc_amt_sum_3m,
    SUM(b.GSC_WEB_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_web_pv_lc_amt_sum_6m,
    SUM(b.GSC_WEB_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_web_pv_lc_amt_sum_9m,
    SUM(b.GSC_WEB_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_web_pv_lc_amt_sum_12m,
    b.GSC_WALK_PV_LC_AMT as n_gsc_walk_pv_lc_amt,
    LAG(b.GSC_WALK_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_walk_pv_lc_amt_previous,
    SUM(b.GSC_WALK_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_walk_pv_lc_amt_sum_3m,
    SUM(b.GSC_WALK_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_walk_pv_lc_amt_sum_6m,
    SUM(b.GSC_WALK_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_walk_pv_lc_amt_sum_9m,
    SUM(b.GSC_WALK_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_walk_pv_lc_amt_sum_12m,
    b.GSC_TEL_PV_LC_AMT as n_gsc_TEL_pv_lc_amt,
    LAG(b.GSC_TEL_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_TEL_pv_lc_amt_previous,
    SUM(b.GSC_TEL_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_TEL_pv_lc_amt_sum_3m,
    SUM(b.GSC_TEL_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_TEL_pv_lc_amt_sum_6m,
    SUM(b.GSC_TEL_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_TEL_pv_lc_amt_sum_9m,
    SUM(b.GSC_TEL_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_TEL_pv_lc_amt_sum_12m,
    b.GSC_MOB_PV_LC_AMT as n_gsc_MOB_pv_lc_amt,
    LAG(b.GSC_MOB_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_MOB_pv_lc_amt_previous,
    SUM(b.GSC_MOB_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_MOB_pv_lc_amt_sum_3m,
    SUM(b.GSC_MOB_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_MOB_pv_lc_amt_sum_6m,
    SUM(b.GSC_MOB_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_MOB_pv_lc_amt_sum_9m,
    SUM(b.GSC_MOB_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_MOB_pv_lc_amt_sum_12m,
    b.GSC_OTHR_PV_LC_AMT as n_gsc_OTHR_pv_lc_amt,
    LAG(b.GSC_OTHR_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_OTHR_pv_lc_amt_previous,
    SUM(b.GSC_OTHR_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_OTHR_pv_lc_amt_sum_3m,
    SUM(b.GSC_OTHR_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_OTHR_pv_lc_amt_sum_6m,
    SUM(b.GSC_OTHR_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_OTHR_pv_lc_amt_sum_9m,
    SUM(b.GSC_OTHR_PV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_OTHR_pv_lc_amt_sum_12m,

    nvl(b.GSC_WEB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) as n_pct_pv_gsc_web,
    LAG(nvl(b.GSC_WEB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_gsc_web_previous,
    AVG(nvl(b.GSC_WEB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_gsc_web_avg_3m,
    AVG(nvl(b.GSC_WEB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_gsc_web_avg_6m,
    AVG(nvl(b.GSC_WEB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_gsc_web_avg_9m,
    AVG(nvl(b.GSC_WEB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_gsc_web_avg_12m,

    nvl(b.GSC_WALK_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) as n_pct_pv_gsc_WALK,
    LAG(nvl(b.GSC_WALK_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_gsc_WALK_previous,
    AVG(nvl(b.GSC_WALK_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_gsc_WALK_avg_3m,
    AVG(nvl(b.GSC_WALK_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_gsc_WALK_avg_6m,
    AVG(nvl(b.GSC_WALK_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_gsc_WALK_avg_9m,
    AVG(nvl(b.GSC_WALK_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_gsc_WALK_avg_12m,
    nvl(b.GSC_TEL_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) as n_pct_pv_gsc_TEL,
    LAG(nvl(b.GSC_TEL_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_gsc_TEL_previous,
    AVG(nvl(b.GSC_TEL_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_gsc_TEL_avg_3m,
    AVG(nvl(b.GSC_TEL_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_gsc_TEL_avg_6m,
    AVG(nvl(b.GSC_TEL_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_gsc_TEL_avg_9m,
    AVG(nvl(b.GSC_TEL_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_gsc_TEL_avg_12m,
    nvl(b.GSC_MOB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) as n_pct_pv_gsc_MOB,
    LAG(nvl(b.GSC_MOB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_gsc_MOB_previous,
    AVG(nvl(b.GSC_MOB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_gsc_MOB_avg_3m,
    AVG(nvl(b.GSC_MOB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_gsc_MOB_avg_6m,
    AVG(nvl(b.GSC_MOB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_gsc_MOB_avg_9m,
    AVG(nvl(b.GSC_MOB_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_gsc_MOB_avg_12m,
    nvl(b.GSC_OTHR_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) as n_pct_pv_gsc_OTHR,
    LAG(nvl(b.GSC_OTHR_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) , 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_pv_gsc_OTHR_previous,
    AVG(nvl(b.GSC_OTHR_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_pv_gsc_OTHR_avg_3m,
    AVG(nvl(b.GSC_OTHR_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_pv_gsc_OTHR_avg_6m,
    AVG(nvl(b.GSC_OTHR_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_pv_gsc_OTHR_avg_9m,
    AVG(nvl(b.GSC_OTHR_PV_LC_AMT / NULLIF(b.imc_prsnl_pv,0),0) ) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_pv_gsc_OTHR_avg_12m,

    (CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) as n_gsc_web_pv_nonzero,
    CASE WHEN LAG(b.GSC_WEB_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) > 0 THEN 1 ELSE 0 END as n_gsc_web_pv_nonzero_previous,
    SUM(CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_web_pv_nonzero_mths_3m,
    SUM(CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_web_pv_nonzero_mths_6m,
    SUM(CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_web_pv_nonzero_mths_9m,
    SUM(CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_web_pv_nonzero_mths_12m,
    CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END as n_gsc_WALK_pv_nonzero,
    CASE WHEN LAG(b.GSC_WALK_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) > 0 THEN 1 ELSE 0 END as n_gsc_WALK_pv_nonzero_previous,
    SUM(CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_WALK_pv_nonzero_mths_3m,
    SUM(CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_WALK_pv_nonzero_mths_6m,
    SUM(CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_WALK_pv_nonzero_mths_9m,
    SUM(CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_WALK_pv_nonzero_mths_12m,
    CASE WHEN b.GSC_tel_PV_LC_AMT > 0 THEN 1 ELSE 0 END as n_gsc_tel_pv_nonzero,
    CASE WHEN LAG(b.GSC_tel_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) > 0 THEN 1 ELSE 0 END as n_gsc_tel_pv_nonzero_previous,
    SUM(CASE WHEN b.GSC_tel_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_tel_pv_nonzero_mths_3m,
    SUM(CASE WHEN b.GSC_tel_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_tel_pv_nonzero_mths_6m,
    SUM(CASE WHEN b.GSC_tel_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_tel_pv_nonzero_mths_9m,
    SUM(CASE WHEN b.GSC_tel_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_tel_pv_nonzero_mths_12m,
    CASE WHEN b.GSC_mob_PV_LC_AMT > 0 THEN 1 ELSE 0 END as n_gsc_mob_pv_nonzero,
    CASE WHEN LAG(b.GSC_mob_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) > 0 THEN 1 ELSE 0 END as n_gsc_mob_pv_nonzero_previous,
    SUM(CASE WHEN b.GSC_mob_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_mob_pv_nonzero_mths_3m,
    SUM(CASE WHEN b.GSC_mob_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_mob_pv_nonzero_mths_6m,
    SUM(CASE WHEN b.GSC_mob_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_mob_pv_nonzero_mths_9m,
    SUM(CASE WHEN b.GSC_mob_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_mob_pv_nonzero_mths_12m,
    CASE WHEN b.GSC_othr_PV_LC_AMT > 0 THEN 1 ELSE 0 END as n_gsc_othr_pv_nonzero,
    CASE WHEN LAG(b.GSC_othr_PV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) > 0 THEN 1 ELSE 0 END as n_gsc_othr_pv_nonzero_previous,
    SUM(CASE WHEN b.GSC_othr_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_othr_pv_nonzero_mths_3m,
    SUM(CASE WHEN b.GSC_othr_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_othr_pv_nonzero_mths_6m,
    SUM(CASE WHEN b.GSC_othr_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_othr_pv_nonzero_mths_9m,
    SUM(CASE WHEN b.GSC_othr_PV_LC_AMT > 0 THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_othr_pv_nonzero_mths_12m,

    ((CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_MOB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_TEL_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_OTHR_PV_LC_AMT > 0 THEN 1 ELSE 0 END)) as n_gsc_channels_pv_nonzero,
    LAG(((CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_MOB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_TEL_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_OTHR_PV_LC_AMT > 0 THEN 1 ELSE 0 END)), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_channels_pv_nonzero_previous,
    MAX(((CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_MOB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_TEL_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_OTHR_PV_LC_AMT > 0 THEN 1 ELSE 0 END))) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_channels_pv_nonzero_max_3m,
    MAX(((CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_MOB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_TEL_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_OTHR_PV_LC_AMT > 0 THEN 1 ELSE 0 END))) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_channels_pv_nonzero_max_6m,
    MAX(((CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_MOB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_TEL_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_OTHR_PV_LC_AMT > 0 THEN 1 ELSE 0 END))) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_channels_pv_nonzero_max_9m,
    MAX(((CASE WHEN b.GSC_WEB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_WALK_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_MOB_PV_LC_AMT > 0 THEN 1 ELSE 0 END) + (CASE WHEN b.GSC_TEL_PV_LC_AMT > 0 THEN 1 ELSE 0 END) +(CASE WHEN b.GSC_OTHR_PV_LC_AMT > 0 THEN 1 ELSE 0 END))) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_channels_pv_nonzero_max_12m,

    b.GSC_WEB_BV_LC_AMT as n_gsc_web_BV_lc_amt,
    LAG(b.GSC_WEB_BV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_web_BV_lc_amt_previous,
    SUM(b.GSC_WEB_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_web_BV_lc_amt_sum_3m,
    SUM(b.GSC_WEB_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_web_BV_lc_amt_sum_6m,
    SUM(b.GSC_WEB_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_web_BV_lc_amt_sum_9m,
    SUM(b.GSC_WEB_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_web_BV_lc_amt_sum_12m,
    b.GSC_WALK_BV_LC_AMT as n_gsc_walk_BV_lc_amt,
    LAG(b.GSC_WALK_BV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_walk_BV_lc_amt_previous,
    SUM(b.GSC_WALK_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_walk_BV_lc_amt_sum_3m,
    SUM(b.GSC_WALK_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_walk_BV_lc_amt_sum_6m,
    SUM(b.GSC_WALK_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_walk_BV_lc_amt_sum_9m,
    SUM(b.GSC_WALK_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_walk_BV_lc_amt_sum_12m,
    b.GSC_TEL_BV_LC_AMT as n_gsc_TEL_BV_lc_amt,
    LAG(b.GSC_TEL_BV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_TEL_BV_lc_amt_previous,
    SUM(b.GSC_TEL_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_TEL_BV_lc_amt_sum_3m,
    SUM(b.GSC_TEL_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_TEL_BV_lc_amt_sum_6m,
    SUM(b.GSC_TEL_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_TEL_BV_lc_amt_sum_9m,
    SUM(b.GSC_TEL_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_TEL_BV_lc_amt_sum_12m,
    b.GSC_MOB_BV_LC_AMT as n_gsc_MOB_BV_lc_amt,
    LAG(b.GSC_MOB_BV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_MOB_BV_lc_amt_previous,
    SUM(b.GSC_MOB_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_MOB_BV_lc_amt_sum_3m,
    SUM(b.GSC_MOB_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_MOB_BV_lc_amt_sum_6m,
    SUM(b.GSC_MOB_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_MOB_BV_lc_amt_sum_9m,
    SUM(b.GSC_MOB_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_MOB_BV_lc_amt_sum_12m,
    b.GSC_OTHR_BV_LC_AMT as n_gsc_OTHR_BV_lc_amt,
    LAG(b.GSC_OTHR_BV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_OTHR_BV_lc_amt_previous,
    SUM(b.GSC_OTHR_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_OTHR_BV_lc_amt_sum_3m,
    SUM(b.GSC_OTHR_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_OTHR_BV_lc_amt_sum_6m,
    SUM(b.GSC_OTHR_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_OTHR_BV_lc_amt_sum_9m,
    SUM(b.GSC_OTHR_BV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_OTHR_BV_lc_amt_sum_12m,

    b.GSC_WEB_REV_LC_AMT as n_gsc_web_REV_lc_amt,
    LAG(b.GSC_WEB_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_web_REV_lc_amt_previous,
    SUM(b.GSC_WEB_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_web_REV_lc_amt_sum_3m,
    SUM(b.GSC_WEB_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_web_REV_lc_amt_sum_6m,
    SUM(b.GSC_WEB_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_web_REV_lc_amt_sum_9m,
    SUM(b.GSC_WEB_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_web_REV_lc_amt_sum_12m,
    b.GSC_WALK_REV_LC_AMT as n_gsc_walk_REV_lc_amt,
    LAG(b.GSC_WALK_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_walk_REV_lc_amt_previous,
    SUM(b.GSC_WALK_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_walk_REV_lc_amt_sum_3m,
    SUM(b.GSC_WALK_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_walk_REV_lc_amt_sum_6m,
    SUM(b.GSC_WALK_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_walk_REV_lc_amt_sum_9m,
    SUM(b.GSC_WALK_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_walk_REV_lc_amt_sum_12m,
    b.GSC_TEL_REV_LC_AMT as n_gsc_TEL_REV_lc_amt,
    LAG(b.GSC_TEL_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_TEL_REV_lc_amt_previous,
    SUM(b.GSC_TEL_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_TEL_REV_lc_amt_sum_3m,
    SUM(b.GSC_TEL_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_TEL_REV_lc_amt_sum_6m,
    SUM(b.GSC_TEL_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_TEL_REV_lc_amt_sum_9m,
    SUM(b.GSC_TEL_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_TEL_REV_lc_amt_sum_12m,
    b.GSC_MOB_REV_LC_AMT as n_gsc_MOB_REV_lc_amt,
    LAG(b.GSC_MOB_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_MOB_REV_lc_amt_previous,
    SUM(b.GSC_MOB_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_MOB_REV_lc_amt_sum_3m,
    SUM(b.GSC_MOB_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_MOB_REV_lc_amt_sum_6m,
    SUM(b.GSC_MOB_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_MOB_REV_lc_amt_sum_9m,
    SUM(b.GSC_MOB_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_MOB_REV_lc_amt_sum_12m,
    b.GSC_OTHR_REV_LC_AMT as n_gsc_OTHR_REV_lc_amt,
    LAG(b.GSC_OTHR_REV_LC_AMT, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_gsc_OTHR_REV_lc_amt_previous,
    SUM(b.GSC_OTHR_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_gsc_OTHR_REV_lc_amt_sum_3m,
    SUM(b.GSC_OTHR_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_gsc_OTHR_REV_lc_amt_sum_6m,
    SUM(b.GSC_OTHR_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_gsc_OTHR_REV_lc_amt_sum_9m,
    SUM(b.GSC_OTHR_REV_LC_AMT) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_gsc_OTHR_REV_lc_amt_sum_12m,




    b.imc_group_pv as n_imc_group_pv,
    LAG(b.imc_group_pv, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_imc_group_pv_previous,
    SUM(b.imc_group_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_imc_group_pv_sum_3m,
    SUM(b.imc_group_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_imc_group_pv_sum_6m,
    SUM(b.imc_group_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_imc_group_pv_sum_9m,
    SUM(b.imc_group_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_imc_group_pv_sum_12m,

    nvl(b.imc_prsnl_pv / NULLIF(b.imc_group_pv,0),0) as n_pv_ratio,
    nvl(LAG(b.imc_prsnl_pv, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) / NULLIF(LAG(b.imc_group_pv, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no),0),0) as n_pv_ratio_previous,
    nvl(SUM(b.imc_prsnl_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) / NULLIF(SUM(b.imc_group_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING), 0), 0) as n_pv_ratio_3m,
    nvl(SUM(b.imc_prsnl_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) / NULLIF(SUM(b.imc_group_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING), 0), 0) as n_pv_ratio_6m,
    nvl(SUM(b.imc_prsnl_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) / NULLIF(SUM(b.imc_group_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING), 0), 0) as n_pv_ratio_9m,
    nvl(SUM(b.imc_prsnl_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) / NULLIF(SUM(b.imc_group_pv) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING), 0), 0) as n_pv_ratio_12m,




    b.imc_qual_legs_qty as n_imc_qual_legs,
    LAG(b.imc_qual_legs_qty, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_imc_qual_legs_previous,
    AVG(b.imc_qual_legs_qty) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_imc_qual_legs_avg_3m,
    AVG(b.imc_qual_legs_qty) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_imc_qual_legs_avg_6m,
    AVG(b.imc_qual_legs_qty) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_imc_qual_legs_avg_9m,
    AVG(b.imc_qual_legs_qty) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_imc_qual_legs_avg_12m,

    CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END as n_q_mth,
    CASE WHEN LAG(b.IMC_SLVR_PROD_MO_FLG, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) = 'Y' THEN 1 ELSE 0 END as n_q_mth_previous,
    SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_q_mth_sum_3m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_q_mth_sum_6m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_q_mth_sum_9m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_q_mth_sum_12m,

    CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END as n_qv_mth,
    CASE WHEN LAG(b.IMC_SLVR_PROD_QV_MO_FLG, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) = 'Y' THEN 1 ELSE 0 END as n_qv_mth_previous,
    SUM(CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_qv_mth_sum_3m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_qv_mth_sum_6m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_qv_mth_sum_9m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_qv_mth_sum_12m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING),0),0) as n_pct_q_mth_qv_3m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING),0),0) as n_pct_q_mth_qv_6m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING),0),0) as n_pct_q_mth_qv_9m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_QV_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING),0),0) as n_pct_q_mth_qv_12m,

    CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END as n_q1_mth,
    CASE WHEN LAG(b.IMC_SLVR_PROD_Q1_MO_FLG, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) = 'Y' THEN 1 ELSE 0 END as n_q1_mth_previous,
    SUM(CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_q1_mth_sum_3m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_q1_mth_sum_6m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_q1_mth_sum_9m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_q1_mth_sum_12m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING),0),0) as n_pct_q_mth_Q1_3m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING),0),0) as n_pct_q_mth_Q1_6m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING),0),0) as n_pct_q_mth_Q1_9m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_Q1_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING),0),0) as n_pct_q_mth_Q1_12m,

    CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END as n_q2_mth,
    CASE WHEN LAG(b.IMC_SLVR_PROD_Q2_MO_FLG, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) = 'Y' THEN 1 ELSE 0 END as n_q2_mth_previous,
    SUM(CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_q2_mth_sum_3m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_q2_mth_sum_6m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_q2_mth_sum_9m,
    SUM(CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_q2_mth_sum_12m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING),0),0) as n_pct_q_mth_Q2_3m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING),0),0) as n_pct_q_mth_Q2_6m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING),0),0) as n_pct_q_mth_Q2_9m,
    nvl(SUM(CASE WHEN b.IMC_SLVR_PROD_Q2_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) / NULLIF(SUM(CASE WHEN b.IMC_SLVR_PROD_MO_FLG = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION by b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING),0),0) as n_pct_q_mth_Q2_12m,

    CASE WHEN b.imc_spon_flg = 'Y' THEN 1 ELSE 0 END as n_imc_sponsor,
    CASE WHEN LAG(b.imc_spon_flg, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) = 'Y' THEN 1 ELSE 0 END as n_imc_sponsor_previous,
    SUM(CASE WHEN b.imc_spon_flg = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_imc_sponsor_sum_3m,
    SUM(CASE WHEN b.imc_spon_flg = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_imc_sponsor_sum_6m,
    SUM(CASE WHEN b.imc_spon_flg = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_imc_sponsor_sum_9m,
    SUM(CASE WHEN b.imc_spon_flg = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_imc_sponsor_sum_12m,

    b.frontln_distb_cnt - (LAG(b.frontln_distb_cnt, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no)) as n_abos_added,
    b.frontln_distb_cnt - (LAG(b.frontln_distb_cnt, 2) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no)) as n_abos_added_past_3m,
    b.frontln_distb_cnt - (LAG(b.frontln_distb_cnt, 5) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no)) as n_abos_added_past_6m,
    b.frontln_distb_cnt - (LAG(b.frontln_distb_cnt, 8) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no)) as n_abos_added_past_9m,
    b.frontln_distb_cnt - (LAG(b.frontln_distb_cnt, 11) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no)) as n_abos_added_past_12m,

    b.cur_awd_awd_rnk_no as i_awd_rnk,
    LAG(b.cur_awd_awd_rnk_no, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as i_awd_rnk_previous,
    MAX(replace(b.cur_awd_awd_rnk_no, '*NA', '0')) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as i_awd_rnk_max_3m,
    MAX(replace(b.cur_awd_awd_rnk_no, '*NA', '0')) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as i_awd_rnk_max_6m,
    MAX(replace(b.cur_awd_awd_rnk_no, '*NA', '0')) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as i_awd_rnk_max_9m,
    MAX(replace(b.cur_awd_awd_rnk_no, '*NA', '0')) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as i_awd_rnk_max_12m,

    (CASE WHEN b.cur_awd_awd_rnk_no = '*NA' THEN 0 WHEN b.cur_awd_awd_rnk_no = '-1' THEN 0 ELSE 1 END) as n_awd_achieved,
    (CASE WHEN LAG(b.cur_awd_awd_rnk_no) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) = '*NA' THEN 0 WHEN LAG(b.cur_awd_awd_rnk_no) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) = '-1' THEN 0 ELSE 1 END) as n_awd_achieved_previous,
    SUM(CASE WHEN b.cur_awd_awd_rnk_no = '*NA' THEN 0 WHEN b.cur_awd_awd_rnk_no = '-1' THEN 0 ELSE 1 END) OVER  (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_awd_achieved_sum_3m,
    SUM(CASE WHEN b.cur_awd_awd_rnk_no = '*NA' THEN 0 WHEN b.cur_awd_awd_rnk_no = '-1' THEN 0 ELSE 1 END) OVER  (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_awd_achieved_sum_6m,
    SUM(CASE WHEN b.cur_awd_awd_rnk_no = '*NA' THEN 0 WHEN b.cur_awd_awd_rnk_no = '-1' THEN 0 ELSE 1 END) OVER  (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_awd_achieved_sum_9m,
    SUM(CASE WHEN b.cur_awd_awd_rnk_no = '*NA' THEN 0 WHEN b.cur_awd_awd_rnk_no = '-1' THEN 0 ELSE 1 END) OVER  (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_awd_achieved_sum_12m,

    nvl(b.imc_total_dwnln_pv,0) as n_total_downline_pv,
    LAG(nvl(b.imc_total_dwnln_pv,0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_total_downline_pv_previous,
    AVG(nvl(b.imc_total_dwnln_pv,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_total_downline_pv_avg_3m,
    AVG(nvl(b.imc_total_dwnln_pv,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_total_downline_pv_avg_6m,
    AVG(nvl(b.imc_total_dwnln_pv,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_total_downline_pv_avg_9m,
    AVG(nvl(b.imc_total_dwnln_pv,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_total_downline_pv_avg_12m,






    dispy.region as i_region,
    dispy.disposable_income_yuan as n_region_yearly_disp_income_yuan,
    nvl(b.bns_grs_pln_comm_curr_amt / dispy.disposable_income_yuan, 0) as n_pct_region_disp_income_earned,
    nvl(LAG(b.bns_grs_pln_comm_curr_amt, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) / dispy.disposable_income_yuan, 0) as n_pct_region_disp_income_earned_previous,
    nvl(SUM(b.bns_grs_pln_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) / dispy.disposable_income_yuan, 0) as n_pct_region_disp_income_earned_3m,
    nvl(SUM(b.bns_grs_pln_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) / dispy.disposable_income_yuan, 0) as n_pct_region_disp_income_earned_6m,
    nvl(SUM(b.bns_grs_pln_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) / dispy.disposable_income_yuan, 0) as n_pct_region_disp_income_earned_9m,
    nvl(SUM(b.bns_grs_pln_comm_curr_amt) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) / dispy.disposable_income_yuan, 0) as n_pct_region_disp_income_earned_12m,

    py.perf_yr as i_perf_yr,



    nvl(f.n_first_order, 0) as n_first_order,
    nvl(f.n_first_silver, 0) as n_first_silver,
    nvl(f.n_first_gold, 0) as n_first_gold,
    nvl(f.n_first_dd, 0) as n_first_dd,
    nvl(f.n_first_3pctbns, 0) as n_first_3pctbns,
    nvl(f.n_first_6pctbns, 0) as n_first_6pctbns,
    nvl(f.n_first_9pctbns, 0) as n_first_9pctbns,
    nvl(f.n_first_12pctbns, 0) as n_first_12pctbns,
    nvl(f.n_first_15pctbns, 0) as n_first_15pctbns,
    nvl(f.n_first_18pctbns, 0) as n_first_18pctbns,
    nvl(f.n_first_21pctbns, 0) as n_first_21pctbns,
    nvl(f.n_first_sr, 0) as n_first_sr,
    nvl(f.n_first_aa, 0) as n_first_aa,

    nvl(pm.n_beauty_promo, 0) as n_promo_beauty,
    nvl(pm.beauty_multiple, 0) as n_promo_beauty_multiple,
    nvl(pm.n_durables_promo, 0) as n_promo_durables,
    nvl(pm.durables_multiple, 0) as n_promo_durables_multiple,
    nvl(pm.n_homecare_promo, 0) as n_promo_homecare,
    nvl(pm.homecare_multiple, 0) as n_promo_homecare_multiple,
    nvl(pm.n_perscare_promo, 0) as n_promo_perscare,
    nvl(pm.perscare_multiple, 0) as n_promo_perscare_multiple,
    nvl(pm.n_nutrition_promo, 0) as n_promo_nutrition,
    nvl(pm.nutrition_multiple, 0) as n_promo_nutrition_multiple,
    nvl(pm.n_others_promo, 0) as n_promo_others,
    nvl(pm.others_multiple, 0) as n_promo_others_multiple,
    nvl(pm.n_all_promo, 0) as n_promo_all,
    nvl(pm.all_multiple, 0) as n_promo_all_multiple,

    nvl(dn.n_downline_all, 0) as n_downline_all,
	nvl(dn.n_downline_ABOs, 0) as n_downline_ABOs,
    LAG(nvl(dn.n_downline_ABOs, 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_downline_ABOs_previous,
    AVG(nvl(dn.n_downline_ABOs, 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_downline_ABOs_avg_3m,
    AVG(nvl(dn.n_downline_ABOs, 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_downline_ABOs_avg_6m,
    AVG(nvl(dn.n_downline_ABOs, 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_downline_ABOs_avg_9m,
    AVG(nvl(dn.n_downline_ABOs, 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_downline_ABOs_avg_12m,
    nvl(dn.n_downline_ABOs / NULLIF(dn.n_downline_all, 0), 0) as n_pct_downline_ABOs,
    LAG(nvl(dn.n_downline_ABOs / NULLIF(dn.n_downline_all, 0), 0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_pct_downline_ABOs_previous,
    AVG(nvl(dn.n_downline_ABOs / NULLIF(dn.n_downline_all, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_downline_ABOs_avg_3m,
    AVG(nvl(dn.n_downline_ABOs / NULLIF(dn.n_downline_all, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_downline_ABOs_avg_6m,
    AVG(nvl(dn.n_downline_ABOs / NULLIF(dn.n_downline_all, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_downline_ABOs_avg_9m,
    AVG(nvl(dn.n_downline_ABOs / NULLIF(dn.n_downline_all, 0), 0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_downline_ABOs_avg_12m,
	nvl(dn.n_downline_customers, 0) as n_downline_customers,
    LAG(nvl(dn.n_downline_customers,0), 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_downline_customers_previous,
    AVG(nvl(dn.n_downline_customers,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_downline_customers_avg_3m,
    AVG(nvl(dn.n_downline_customers,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_downline_customers_avg_6m,
    AVG(nvl(dn.n_downline_customers,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_downline_customers_avg_9m,
    AVG(nvl(dn.n_downline_customers,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_downline_customers_avg_12m,
    nvl(dn.n_downline_customers_repeat, 0) as n_downline_customers_repeat,
    LAG(nvl(dn.n_downline_customers_repeat, 0),1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_downline_customers_repeat_previous,
    AVG(nvl(dn.n_downline_customers_repeat,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_downline_customers_repeat_avg_3m,
    AVG(nvl(dn.n_downline_customers_repeat,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_downline_customers_repeat_avg_6m,
    AVG(nvl(dn.n_downline_customers_repeat,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_downline_customers_repeat_avg_9m,
    AVG(nvl(dn.n_downline_customers_repeat,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_downline_customers_repeat_avg_12m,
	nvl(dn.n_downline_prsnl_pv_sum, 0) as n_downline_prsnl_pv_sum,
    nvl(dn.n_downline_customer_prsnl_pv_sum, 0) as n_downline_customer_prsnl_pv_sum,
    nvl(dn.n_downline_ABO_prsnl_pv_sum, 0) as n_downline_ABO_prsnl_pv_sum,
    nvl(dn.n_downline_ABO_prsnl_pv_sum / NULLIF(dn.n_downline_prsnl_pv_sum, 0), 0) as n_pct_downline_pv_from_ABOs,
	nvl(dn.n_downline_group_pv_sum, 0) as n_downline_group_pv_sum,
	nvl(dn.n_downline_dmd_ord_sum, 0) as n_downline_dmd_ord_sum,
	nvl(dn.n_downline_dmd_ord_nonzero, 0) as n_downline_dmd_ord_nonzero,
	nvl(dn.n_downline_sponsor, 0) as n_downline_sponsor,
	nvl(dn.n_downline_awd_achieved, 0) as n_downline_awd_achieved,
    nvl(dn.n_downline_310_awd, 0) as n_downline_310_awd,
    nvl(dn.n_downline_310_awd / NULLIF(dn.n_downline_ABOs, 0), 0) as n_downline_pct_ABO_310_awd,
    nvl(dn.n_downline_320_awd / NULLIF(dn.n_downline_ABOs, 0), 0) as n_downline_pct_ABO_320_awd,
    nvl(dn.i_downline_awd_max, '0') as i_downline_awd_max,
    nvl(dn.n_downline_320_awd, 0) as n_downline_320_awd,
	nvl(dn.n_downline_frontln_ABO_sum, 0) as n_downline_frontln_ABO_sum,
	nvl(dn.n_downline_frontln_customer_sum, 0) as n_downline_frontln_customer_sum,
    nvl(dn.n_downline_9plus_bns_pct_mth, 0) as n_downline_9plus_bns_pct_mth,
	nvl(dn.n_downline_q_mth, 0) as n_downline_q_mth,
	nvl(dn.n_downline_qv_mth, 0) as n_downline_qv_mth,
	nvl(dn.n_downline_q1_mth, 0) as n_downline_q1_mth,
	nvl(dn.n_downline_q2_mth, 0) as n_downline_q2_mth,


    up.cur_awd_awd_rnk_no as i_upline_awd_rnk,
    up.imc_months_after_signup as n_upline_tenure,
    upg.n_downline_ABOs - LAG(upg.n_downline_ABOs, 1) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_upline_abos_added,
    upg.n_downline_ABOs - LAG(upg.n_downline_ABOs, 2) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_upline_abos_added_3m,
    upg.n_downline_ABOs - LAG(upg.n_downline_ABOs, 5) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_upline_abos_added_6m,
    upg.n_downline_ABOs - LAG(upg.n_downline_ABOs, 8) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_upline_abos_added_9m,
    upg.n_downline_ABOs - LAG(upg.n_downline_ABOs, 11) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no) as n_upline_abos_added_12m,

	upg.n_downline_ABOs as n_upline_group_ABOs,
	upg.n_downline_customers as n_upline_group_customers,
	upg.n_downline_prsnl_pv_sum as n_upline_group_prsnl_pv_sum,
	upg.n_downline_group_pv_sum as n_upline_group_group_pv_sum,
	upg.n_downline_dmd_ord_sum as n_upline_group_dmd_ord_sum,
	upg.n_downline_dmd_ord_nonzero as n_upline_group_dmd_ord_nonzero,
	upg.n_downline_sponsor as n_upline_group_sponsor,
	upg.n_downline_awd_achieved as n_upline_group_awd_achieved,
	upg.n_downline_q_mth as n_upline_group_q_mth,
	upg.n_downline_qv_mth as n_upline_group_qv_mth,
	upg.n_downline_q1_mth as n_upline_group_q1_mth,
	upg.n_downline_q2_mth as n_upline_group_q2_mth,

    sil.n_los_sil_head_exists,
	sil.n_los_sil_leaves,
    sil.n_LOS_sil_pv_per_member,
	sil.n_los_sil_abos,
	sil.n_los_sil_abos_engaged,
	sil.n_los_sil_customers,
	sil.n_los_sil_customers_avg_12m,
	sil.n_los_sil_customers_avg_3m,
	sil.n_los_sil_customers_avg_6m,
	sil.n_los_sil_customers_avg_9m,
	sil.n_los_sil_customers_repeat,
	sil.n_los_sil_customers_repeat_avg_12m,
	sil.n_los_sil_customers_repeat_avg_3m,
	sil.n_los_sil_customers_repeat_avg_6m,
	sil.n_los_sil_customers_repeat_avg_9m,
	sil.n_los_sil_q_mth,
	sil.n_los_sil_q_mth_avg_12m,
	sil.n_los_sil_q_mth_avg_3m,
	sil.n_los_sil_q_mth_avg_6m,
	sil.n_los_sil_q_mth_avg_9m,
	sil.n_los_sil_qv_mth,
	sil.n_los_sil_q1_mth,
	sil.n_los_sil_q2_mth,
	sil.n_los_sil_head_frontln_abos,
	sil.n_los_sil_head_frontln_customers,
	sil.n_los_sil_head_frontln_q_mth,
	sil.n_los_sil_head_frontln_q_mth_avg_12m,
	sil.n_los_sil_head_frontln_q_mth_avg_3m,
	sil.n_los_sil_head_frontln_q_mth_avg_6m,
	sil.n_los_sil_head_frontln_q_mth_avg_9m,
	sil.n_los_sil_head_frontln_qv_mth,
	sil.n_los_sil_head_frontln_q1_mth,
	sil.n_los_sil_head_frontln_q2_mth,
    gld.n_los_gld_head_exists,
	gld.n_los_gld_leaves,
    gld.n_LOS_gld_pv_per_member,
	gld.n_los_gld_abos,
	gld.n_los_gld_abos_engaged,
	gld.n_los_gld_customers,
	gld.n_los_gld_customers_avg_12m,
	gld.n_los_gld_customers_avg_3m,
	gld.n_los_gld_customers_avg_6m,
	gld.n_los_gld_customers_avg_9m,
	gld.n_los_gld_customers_repeat,
	gld.n_los_gld_customers_repeat_avg_12m,
	gld.n_los_gld_customers_repeat_avg_3m,
	gld.n_los_gld_customers_repeat_avg_6m,
	gld.n_los_gld_customers_repeat_avg_9m,
	gld.n_los_gld_q_mth,
	gld.n_los_gld_q_mth_avg_12m,
	gld.n_los_gld_q_mth_avg_3m,
	gld.n_los_gld_q_mth_avg_6m,
	gld.n_los_gld_q_mth_avg_9m,
	gld.n_los_gld_qv_mth,
	gld.n_los_gld_q1_mth,
	gld.n_los_gld_q2_mth,
	gld.n_los_gld_head_frontln_abos,
	gld.n_los_gld_head_frontln_customers,
	gld.n_los_gld_head_frontln_q_mth,
	gld.n_los_gld_head_frontln_q_mth_avg_12m,
	gld.n_los_gld_head_frontln_q_mth_avg_3m,
	gld.n_los_gld_head_frontln_q_mth_avg_6m,
	gld.n_los_gld_head_frontln_q_mth_avg_9m,
	gld.n_los_gld_head_frontln_qv_mth,
	gld.n_los_gld_head_frontln_q1_mth,
	gld.n_los_gld_head_frontln_q2_mth,
    plat.n_los_plat_head_exists,
	plat.n_los_plat_leaves,
    plat.n_LOS_plat_pv_per_member,
	plat.n_los_plat_abos,
	plat.n_los_plat_abos_engaged,
	plat.n_los_plat_customers,
	plat.n_los_plat_customers_avg_12m,
	plat.n_los_plat_customers_avg_3m,
	plat.n_los_plat_customers_avg_6m,
	plat.n_los_plat_customers_avg_9m,
	plat.n_los_plat_customers_repeat,
	plat.n_los_plat_customers_repeat_avg_12m,
	plat.n_los_plat_customers_repeat_avg_3m,
	plat.n_los_plat_customers_repeat_avg_6m,
	plat.n_los_plat_customers_repeat_avg_9m,
	plat.n_los_plat_q_mth,
	plat.n_los_plat_q_mth_avg_12m,
	plat.n_los_plat_q_mth_avg_3m,
	plat.n_los_plat_q_mth_avg_6m,
	plat.n_los_plat_q_mth_avg_9m,
	plat.n_los_plat_qv_mth,
	plat.n_los_plat_q1_mth,
	plat.n_los_plat_q2_mth,
	plat.n_los_plat_head_frontln_abos,
	plat.n_los_plat_head_frontln_customers,
	plat.n_los_plat_head_frontln_q_mth,
	plat.n_los_plat_head_frontln_q_mth_avg_12m,
	plat.n_los_plat_head_frontln_q_mth_avg_3m,
	plat.n_los_plat_head_frontln_q_mth_avg_6m,
	plat.n_los_plat_head_frontln_q_mth_avg_9m,
	plat.n_los_plat_head_frontln_qv_mth,
	plat.n_los_plat_head_frontln_q1_mth,
	plat.n_los_plat_head_frontln_q2_mth,
    emd.n_los_emd_head_exists,
	emd.n_los_emd_leaves,
    emd.n_LOS_emd_pv_per_member,
	emd.n_los_emd_abos,
	emd.n_los_emd_abos_engaged,
	emd.n_los_emd_customers,
	emd.n_los_emd_customers_avg_12m,
	emd.n_los_emd_customers_avg_3m,
	emd.n_los_emd_customers_avg_6m,
	emd.n_los_emd_customers_avg_9m,
	emd.n_los_emd_customers_repeat,
	emd.n_los_emd_customers_repeat_avg_12m,
	emd.n_los_emd_customers_repeat_avg_3m,
	emd.n_los_emd_customers_repeat_avg_6m,
	emd.n_los_emd_customers_repeat_avg_9m,
	emd.n_los_emd_q_mth,
	emd.n_los_emd_q_mth_avg_12m,
	emd.n_los_emd_q_mth_avg_3m,
	emd.n_los_emd_q_mth_avg_6m,
	emd.n_los_emd_q_mth_avg_9m,
	emd.n_los_emd_qv_mth,
	emd.n_los_emd_q1_mth,
	emd.n_los_emd_q2_mth,
	emd.n_los_emd_head_frontln_abos,
	emd.n_los_emd_head_frontln_customers,
	emd.n_los_emd_head_frontln_q_mth,
	emd.n_los_emd_head_frontln_q_mth_avg_12m,
	emd.n_los_emd_head_frontln_q_mth_avg_3m,
	emd.n_los_emd_head_frontln_q_mth_avg_6m,
	emd.n_los_emd_head_frontln_q_mth_avg_9m,
	emd.n_los_emd_head_frontln_qv_mth,
	emd.n_los_emd_head_frontln_q1_mth,
	emd.n_los_emd_head_frontln_q2_mth,
    dia.n_los_dia_head_exists,
	dia.n_los_dia_leaves,
    dia.n_LOS_dia_pv_per_member,
	dia.n_los_dia_abos,
	dia.n_los_dia_abos_engaged,
	dia.n_los_dia_customers,
	dia.n_los_dia_customers_avg_12m,
	dia.n_los_dia_customers_avg_3m,
	dia.n_los_dia_customers_avg_6m,
	dia.n_los_dia_customers_avg_9m,
	dia.n_los_dia_customers_repeat,
	dia.n_los_dia_customers_repeat_avg_12m,
	dia.n_los_dia_customers_repeat_avg_3m,
	dia.n_los_dia_customers_repeat_avg_6m,
	dia.n_los_dia_customers_repeat_avg_9m,
	dia.n_los_dia_q_mth,
	dia.n_los_dia_q_mth_avg_12m,
	dia.n_los_dia_q_mth_avg_3m,
	dia.n_los_dia_q_mth_avg_6m,
	dia.n_los_dia_q_mth_avg_9m,
	dia.n_los_dia_qv_mth,
	dia.n_los_dia_q1_mth,
	dia.n_los_dia_q2_mth,
	dia.n_los_dia_head_frontln_abos,
	dia.n_los_dia_head_frontln_customers,
	dia.n_los_dia_head_frontln_q_mth,
	dia.n_los_dia_head_frontln_q_mth_avg_12m,
	dia.n_los_dia_head_frontln_q_mth_avg_3m,
	dia.n_los_dia_head_frontln_q_mth_avg_6m,
	dia.n_los_dia_head_frontln_q_mth_avg_9m,
	dia.n_los_dia_head_frontln_qv_mth,
	dia.n_los_dia_head_frontln_q1_mth,
	dia.n_los_dia_head_frontln_q2_mth,
    nvl(cpio.n_promo_sku_purchased,0) as n_promo_sku_purchased,
    AVG(nvl(cpio.n_promo_sku_purchased,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 2 PRECEDING) as n_pct_promsku_pv_last3_days_avg_3m,
    AVG(nvl(cpio.n_promo_sku_purchased,0))  OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 5 PRECEDING) as n_pct_promsku_pv_last3_days_avg_6m,
    AVG(nvl(cpio.n_promo_sku_purchased,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 8 PRECEDING) as n_pct_promsku_pv_last3_days_avg_9m,
    AVG(nvl(cpio.n_promo_sku_purchased,0)) OVER (PARTITION BY b.imc_key_no ORDER BY b.mo_yr_key_no ROWS 11 PRECEDING) as n_pct_promsku_pv_last3_days_avg_12m,
    case when b.PV_LC_AMT<=0 then 0
        else GREATEST(b.GSC_WEB_PV_LC_AMT, b.GSC_WALK_PV_LC_AMT, b.GSC_TEL_PV_LC_AMT, b.GSC_MOB_PV_LC_AMT, b.GSC_OTHR_PV_LC_AMT)/b.PV_LC_AMT end as n_highest_channel_pct_sales,
    CASE WHEN GREATEST(b.GSC_WEB_PV_LC_AMT, b.GSC_WALK_PV_LC_AMT, b.GSC_TEL_PV_LC_AMT, b.GSC_MOB_PV_LC_AMT, b.GSC_OTHR_PV_LC_AMT)  =0 THEN 'None'
        when GREATEST(b.GSC_WEB_PV_LC_AMT, b.GSC_WALK_PV_LC_AMT, b.GSC_TEL_PV_LC_AMT, b.GSC_MOB_PV_LC_AMT, b.GSC_OTHR_PV_LC_AMT)  = b.GSC_WEB_PV_LC_AMT then 'WEB'
        when GREATEST(b.GSC_WEB_PV_LC_AMT, b.GSC_WALK_PV_LC_AMT, b.GSC_TEL_PV_LC_AMT, b.GSC_MOB_PV_LC_AMT, b.GSC_OTHR_PV_LC_AMT)  = b.GSC_WALK_PV_LC_AMT then 'WALK'
        when GREATEST(b.GSC_WEB_PV_LC_AMT, b.GSC_WALK_PV_LC_AMT, b.GSC_TEL_PV_LC_AMT, b.GSC_MOB_PV_LC_AMT, b.GSC_OTHR_PV_LC_AMT)  = b.GSC_TEL_PV_LC_AMT then 'TEL'
        when GREATEST(b.GSC_WEB_PV_LC_AMT, b.GSC_WALK_PV_LC_AMT, b.GSC_TEL_PV_LC_AMT, b.GSC_MOB_PV_LC_AMT, b.GSC_OTHR_PV_LC_AMT)  = b.GSC_MOB_PV_LC_AMT then 'MOB'
        ELSE 'OTHER' END as i_top_1_channel,

	amh.n_num_amwayhub_login,
	awd.i_mthly_awd_cd,
	awd.i_yrly_awd_cd,
	awd.perf_yr as i_perf_year,
	awd.i_yrly_awd_rnk_no,

	classrm.n_lag_currentyr_download_sum_3m as n_lag_download_classrm_sum_3m,
	classrm.n_lag_currentyr_download_sum_6m as n_lag_download_classrm_sum_6m,
	classrm.n_lag_currentyr_download_sum_9m as n_lag_download_classrm_sum_9m,
	classrm.n_lag_currentyr_download_sum_12m as n_lag_download_classrm_sum_12m,
	
	classrm.n_lag_currentyr_browse_sum_3m as n_lag_browse_classrm_sum_3m,
	classrm.n_lag_currentyr_browse_sum_6m as n_lag_browse_classrm_sum_6m,
	classrm.n_lag_currentyr_browse_sum_9m as n_lag_browse_classrm_sum_9m,
	classrm.n_lag_currentyr_browse_sum_12m as n_lag_browse_classrm_sum_12m,

	classrm.n_lag_currentyr_share_sum_3m as n_lag_share_classrm_sum_3m,
	classrm.n_lag_currentyr_share_sum_6m as n_lag_share_classrm_sum_6m,
	classrm.n_lag_currentyr_share_sum_9m as n_lag_share_classrm_sum_9m,
	classrm.n_lag_currentyr_share_sum_12m as n_lag_share_classrm_sum_12m,

	classrm.n_lag_currentyr_search_sum_3m as n_lag_search_classrm_sum_3m,
	classrm.n_lag_currentyr_search_sum_6m as n_lag_search_classrm_sum_6m,
	classrm.n_lag_currentyr_search_sum_9m as n_lag_search_classrm_sum_9m,
	classrm.n_lag_currentyr_search_sum_12m as n_lag_search_classrm_sum_12m,

	classrm.n_lag_currentyr_fav_sum_3m as n_lag_fav_classrm_sum_3m,
	classrm.n_lag_currentyr_fav_sum_6m as n_lag_fav_classrm_sum_6m,
	classrm.n_lag_currentyr_fav_sum_9m as n_lag_fav_classrm_sum_9m,
	classrm.n_lag_currentyr_fav_sum_12m as n_lag_fav_classrm_sum_12m,

    cloudcom.n_num_cloudcommerce_browse as n_num_cloudcommerce_browse,
    cloudcom.n_num_cloudcommerce_browse_sum_3m as n_num_cloudcommerce_browse_sum_3m,
    cloudcom.n_num_cloudcommerce_browse_sum_6m as n_num_cloudcommerce_browse_sum_6m,
    cloudcom.n_num_cloudcommerce_browse_sum_9m as n_num_cloudcommerce_browse_sum_9m,
    cloudcom.n_num_cloudcommerce_browse_sum_12m as n_num_cloudcommerce_browse_sum_12m,

    cloudcom.n_num_cloudcommerce_search,
    cloudcom.n_num_cloudcommerce_search_sum_3m as n_num_cloudcommerce_search_sum_3m,
    cloudcom.n_num_cloudcommerce_search_sum_6m as n_num_cloudcommerce_search_sum_6m,
    cloudcom.n_num_cloudcommerce_search_sum_9m as n_num_cloudcommerce_search_sum_9m,
    cloudcom.n_num_cloudcommerce_search_sum_12m as n_num_cloudcommerce_search_sum_12m,

    cloudcom.n_num_cloudcommerce_order,
    cloudcom.n_num_cloudcommerce_order_sum_3m as n_num_cloudcommerce_order_sum_3m,
    cloudcom.n_num_cloudcommerce_order_sum_6m as n_num_cloudcommerce_order_sum_6m,
    cloudcom.n_num_cloudcommerce_order_sum_9m as n_num_cloudcommerce_order_sum_9m,
    cloudcom.n_num_cloudcommerce_order_sum_12m as n_num_cloudcommerce_order_sum_12m,

    cloudcom.n_num_cloudcommerce_product_per_cart,
    cloudcom.n_num_cloudcommerce_product_per_cart_sum_3m as n_num_cloudcommerce_product_per_cart_sum_3m,
    cloudcom.n_num_cloudcommerce_product_per_cart_sum_6m as n_num_cloudcommerce_product_per_cart_sum_6m,
    cloudcom.n_num_cloudcommerce_product_per_cart_sum_9m as n_num_cloudcommerce_product_per_cart_sum_9m,    
    cloudcom.n_num_cloudcommerce_product_per_cart_sum_12m as n_num_cloudcommerce_product_per_cart_sum_12m,
    
    fc.dist_num as i_dist_num,
    
    gar.gar_rank_no,
    gar.gar_rank_desc

    
from behaviors_combined_partial b
left join percentile_rank pr on pr.imc_key_no = b.imc_key_no and pr.mo_yr_key_no = b.mo_yr_key_no
left join average_rank ar on ar.mo_yr_key_no = b.mo_yr_key_no
left join average_rank_region ar_region on ar_region.mo_yr_key_no = b.mo_yr_key_no and ar_region.reg_shop_prvnc_nm = b.reg_shop_prvnc_nm
left join average_rank_awd_rnk ar_awd on ar_awd.mo_yr_key_no = b.mo_yr_key_no and ar_awd.cur_awd_awd_rnk_no = b.cur_awd_awd_rnk_no
left join per_capita_disposable_income_v3 dispy on dispy.year = extract(year from b.mo_yr_key_no) and dispy.province_name_zh = b.reg_shop_prvnc_nm
left join performance_year py on py.mo_yr_key_no = b.mo_yr_key_no
left join support_first_indicators f ON b.imc_key_no = f.imc_key_no and b.mo_yr_key_no = f.mo_yr_key_no
left join support_promotions pm on pm.imc_key_no = b.imc_key_no and pm.mo_yr_key_no = b.mo_yr_key_no
left join abo_dna_downline_indiv_vw dn on dn.imc_key_no = b.imc_key_no and dn.mo_yr_key_no = b.mo_yr_key_no
left join behaviors_combined_up up on up.imc_key_no = b.spon_imc_key_no and up.mo_yr_key_no = b.mo_yr_key_no
left join abo_dna_downline_indiv_vw upg on upg.imc_key_no = b.spon_imc_key_no and upg.mo_yr_key_no = b.mo_yr_key_no
left join support_LOS_silver sil on b.cur_sil_imc_no = sil.cur_sil_imc_no and b.mo_yr_key_no = sil.mo_yr_key_no
left join support_LOS_gold gld on b.cur_gld_imc_no = gld.cur_gld_imc_no and b.mo_yr_key_no = gld.mo_yr_key_no
left join support_LOS_plat plat on b.cur_plat_imc_no = plat.cur_plat_imc_no and b.mo_yr_key_no = plat.mo_yr_key_no
left join support_los_emerald emd on b.cur_emd_imc_no = emd.cur_emd_imc_no and b.mo_yr_key_no = emd.mo_yr_key_no
left join support_los_diamond dia on b.cur_dia_imc_no = dia.cur_dia_imc_no and b.mo_yr_key_no = dia.mo_yr_key_no
left join cntry_promo_imc_order cpio on b.imc_key_no = cpio.ord_imc_key_no and b.mo_yr_key_no = cpio.mo_yr_key_no

left join combined_yr_mo_awards awd on awd.imc_key_no = b.imc_key_no and awd.mo_yr_key_no = b.mo_yr_key_no
left join amwayhub_login amh on amh.imc_no = b.imc_no and amh.mo_yr_key_no = b.mo_yr_key_no
left join classroom_data classrm on classrm.imc_no = b.imc_no and classrm.mo_yr_key_no = b.mo_yr_key_no

left join wechat_cloudcommerce cloudcom on cloudcom.imc_no = b.imc_no and cloudcom.mo_yr_key_no = b.mo_yr_key_no

left join fc_dist fc on fc.imc_no = b.imc_no
left join gar_pf_cleaned gar on gar.imc_no = b.imc_no and gar.i_perf_yr = py.perf_yr


where b.cntry_key_no IN ({cntry_list})
"""


step0_query = """
SELECT
IMC_KEY_NO ,
MO_YR_KEY_NO ,
AMWAY_CNTRY_CD ,
GLOBL_IMC_TYPE_CD ,
GLOBL_BUS_STAT_CD ,
IMC_MONTHS_AFTER_SIGNUP ,
I_IMC_EARN_BNS_FLG ,
LAST_RENEW_DT_KEY_NO ,
BNS_GRS_PLN_COMM_CURR_AMT ,
REV_LC_AMT
FROM behaviors_combined
WHERE GLOBL_IMC_TYPE_CD in ('I','C') AND cntry_key_no IN ({cntry_list})
"""


step1_query = """
SELECT
A.IMC_KEY_NO ,
A.MO_YR_KEY_NO ,
A.AMWAY_CNTRY_CD ,
IMC_MONTHS_AFTER_SIGNUP ,
GLOBL_IMC_TYPE_CD ,
BNS_GRS_PLN_COMM_CURR_AMT ,
REV_LC_AMT ,
CASE WHEN IMC_MONTHS_AFTER_SIGNUP >=0 AND IMC_MONTHS_AFTER_SIGNUP <=11 THEN 1 ELSE 0 END AS I_YEAR1 ,
CASE WHEN IMC_MONTHS_AFTER_SIGNUP >=12 AND IMC_MONTHS_AFTER_SIGNUP <=23 THEN 1 ELSE 0 END AS I_YEAR2 ,
CASE WHEN B.I_ACTIVE =1 THEN 1 ELSE 0 END AS I_YEAR1_RENEWAL_FLAG ,
CASE WHEN C.I_ACTIVE =1 THEN 1 ELSE 0 END AS I_YEAR2_RENEWAL_FLAG
FROM tbl_abo_renewal_flag_step0 AS A
LEFT JOIN (SELECT
    DISTINCT
    IMC_KEY_NO  ,
    1 AS I_ACTIVE
    FROM tbl_abo_renewal_flag_step0
    WHERE GLOBL_BUS_STAT_CD='ACTIVE' AND IMC_MONTHS_AFTER_SIGNUP =14   ) AS B
ON A.IMC_KEY_NO = B.IMC_KEY_NO
LEFT JOIN (SELECT
    DISTINCT
    IMC_KEY_NO  ,
    1 AS I_ACTIVE
    FROM tbl_abo_renewal_flag_step0
    WHERE GLOBL_BUS_STAT_CD='ACTIVE' AND IMC_MONTHS_AFTER_SIGNUP =26  ) AS C
ON A.IMC_KEY_NO = C.IMC_KEY_NO
"""


step2_query = """
SELECT
A.* ,
I_M3_IMC_TYPE ,
I_YEAR1_IMC_TYPE
FROM tbl_abo_renewal_flag_step1 AS A
LEFT JOIN (SELECT
    IMC_KEY_NO  ,
    GLOBL_IMC_TYPE_CD AS I_YEAR1_IMC_TYPE
    FROM tbl_abo_renewal_flag_step0
    WHERE IMC_MONTHS_AFTER_SIGNUP=11  ) AS B
ON A.IMC_KEY_NO = B.IMC_KEY_NO
LEFT JOIN (SELECT
    IMC_KEY_NO  ,
    GLOBL_IMC_TYPE_CD AS I_M3_IMC_TYPE
    FROM tbl_abo_renewal_flag_step0
    WHERE IMC_MONTHS_AFTER_SIGNUP=2  ) AS C
ON A.IMC_KEY_NO = C.IMC_KEY_NO
"""


step3_query = """
SELECT
IMC_KEY_NO ,
MO_YR_KEY_NO AS DT_SIGNUP_MONTH ,
EXTRACT(YEAR FROM MO_YR_KEY_NO) AS N_SIGNUP_YEAR ,
AMWAY_CNTRY_CD ,
GLOBL_IMC_TYPE_CD AS I_SIGNUP_IMC_TYPE ,
I_YEAR1 ,
I_YEAR1_RENEWAL_FLAG ,
I_M3_IMC_TYPE ,
I_YEAR1_IMC_TYPE ,
CASE WHEN MO_YR_KEY_NO <='2018-02-01' THEN 1 ELSE 0 END AS I_YEAR1_FULL_HISTORY ,
CASE WHEN I_YEAR1 = 1 AND I_M3_IMC_TYPE = 'I' THEN 1 ELSE 0 END AS I_YEAR1_RENEWAL_IN_FOCUS
FROM tbl_abo_renewal_flag_step2
WHERE IMC_MONTHS_AFTER_SIGNUP = 0
"""


tbl_year1_abo_pc_renewal_query = """
SELECT
IMC_KEY_NO ,
DT_SIGNUP_MONTH ,
N_SIGNUP_YEAR ,
AMWAY_CNTRY_CD ,
I_SIGNUP_IMC_TYPE ,
I_YEAR1_IMC_TYPE ,
I_M3_IMC_TYPE ,
I_YEAR1 ,
I_YEAR1_RENEWAL_FLAG
FROM tbl_abo_renewal_flag_step3
WHERE I_YEAR1_RENEWAL_IN_FOCUS = 1
"""


